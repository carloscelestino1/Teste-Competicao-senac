{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/main/dashboard.css' %}">

<style>
    .dashboard-wrapper {
        padding: 2rem;
        background-color: #f9faff;
    }

    header.flex {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 1rem 2rem;
    }

    header h1 {
        font-size: 1.8rem;
        margin: 0;
    }

    .filters-form {
        margin-bottom: 2rem;
    }

    .filters-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }

    .filter-actions {
        display: flex;
        align-items: flex-end;
    }

    .filter-actions button {
        background-color: #0d6efd;
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .top-row {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .card-section,
    .chart-section {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        flex: 1;
        min-width: 320px;
    }

    .card-section h2,
    .chart-section h2,
    .columnchart h2 {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
        color: #333;
    }

    .cards-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .card {
        font-size: 1.1rem;
        padding: 1rem;
        border-radius: 12px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .card-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-top: 4px;
    }

    .available {
        color: #00ca07;
        border: 2px solid #00ca07;
        background-color: #ecfff0;
    }

    .reserved {
        color: #f44528;
        border: 2px solid #f44528;
        background-color: #fff0ec;
    }

    .full-width-row {
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .columnchart {
        width: 100%;
        max-width: 100%;
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-top: 2rem;
    }

    .columnchart canvas,
    .chart-section canvas {
        width: 100% !important;
        max-width: 100%;
        height: 400px !important;
    }

    canvas {
        display: block;
    }

    .validated {
    color: #00A86B;
    border: 2px solid #00A86B;
    background-color: #e6fff2;
}

</style>

<header class="flex">
    <a href="{% url 'events_list' %}">
        <img src="{% static 'icons/back.svg' %}" alt="Voltar">
    </a>
    <h1>Dashboard: {{ event.title }}</h1>
</header>

<main class="dashboard-wrapper">

    <!-- Filtros -->
    <form method="get" class="filters-form">
        <div class="filters-grid">

            <div class="filter-group">
                <label for="setor">Setor:</label>
                <select id="setor" name="setor">
                    <option value="">Todos</option>
                    {% for s in setores %}
                        <option value="{{ s.id }}" {% if request.GET.setor == s.id|stringformat:"s" %}selected{% endif %}>
                            {{ s.title }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit">Filtrar</button>
            </div>
        </div>
    </form>

    <div class="top-row">
        <!-- Resumo -->
        <section class="card-section">
            <h2>Resumo de Ingressos</h2>
            <div class="cards-wrapper">
                <div class="card available">
                    <div>Ingressos Disponíveis</div>
                    <div class="card-value">{{ disponiveis }}</div>
                </div>
                <div class="card reserved">
                    <div>Ingressos Reservados</div>
                    <div class="card-value">{{ emitidos }}</div>
                </div>
                <div class="card validated">
                    <div>Ingressos Validados</div>
                    <div class="card-value">{{ validados }}</div>
                </div>
            </div>
        </section>

        <!-- Gráfico de Pizza - Disponíveis vs Reservados -->
        <section class="chart-section">
            <h2>Distribuição de Ingressos</h2>
            <canvas id="pie"></canvas>
        </section>

        <!-- Gráfico de Pizza - Status Geral -->
        <section class="chart-section">
            <h2>Distribuição Geral por Checkin</h2>
            <canvas id="statusPie"></canvas>
        </section>
    </div>

    <!-- Gráfico de Barras por Status por Setor -->
    <div class="full-width-row">
        <section class="columnchart">
            <h2>% de Vendas por Setor e Status</h2>
            <canvas id="column"></canvas>
        </section>
    </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico de Pizza - Disponíveis vs Reservados
    new Chart(document.getElementById('pie'), {
        type: 'doughnut',
        data: {
            labels: ['% Disponíveis', '% Reservados'],
            datasets: [{
                label: 'Porcentagem',
                data: [{{ percent_disponiveis }}, {{ percent_emitidos }}],
                backgroundColor: ['#00CA07', '#F44528'],
                hoverOffset: 4
            }]
        }
    });

    // Gráfico de Pizza - Status Geral
    new Chart(document.getElementById('statusPie'), {
        type: 'doughnut',
        data: {
            labels: ['Pendentes', 'Realizados'],
            datasets: [{
                data: [{{ total_pendentes }}, {{ total_realizados }}],
                backgroundColor: ['#F4C542', '#00A86B'],
                hoverOffset: 4
            }]
        }
    });

    // Gráfico de Barras - Por Setor e Status
    new Chart(document.getElementById('column'), {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: [
                {
                    label: '% Pendentes',
                    data: {{ percentuais_pendentes|safe }},
                    backgroundColor: '#F4C542'
                },
                {
                    label: '% Realizados',
                    data: {{ percentuais_realizados|safe }},
                    backgroundColor: '#00A86B'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + "%";
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
